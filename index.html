<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Playlist Transfer: Spotify to YouTube Music</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <!-- The onload attribute starts the gapi initialization process -->
    <script src="https://apis.google.com/js/api.js" async defer onload="onGapiLoad()"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
    <script>
        // --- CONFIGURATION ---
  const SPOTIFY_CLIENT_ID = '3e15d2c4e7d445f8af6415551e023b47'; 
const YOUTUBE_API_KEY = 'AIzaSyBNQ1BKWBMNmjJlazFoX_EQmjlRPzCBVzQ';
const YOUTUBE_CLIENT_ID = '445292307504-moli317tov55j704jlabrb9psvhc7ep5.apps.googleusercontent.com';

        // MAKE SURE THIS EXACT STRING IS IN YOUR SPOTIFY DASHBOARD
        const REDIRECT_URI = 'https://dislocatedmember.github.io/playlist-transfer/';

        // --- STATE ---
        let spotifyAccessToken = null;
        let googleTokenClient = null;

        // --- ERROR HANDLING ---
        function displayError(message) {
            const errorContainer = document.getElementById('error-container');
            const errorMessage = document.getElementById('error-message');
            errorMessage.textContent = message;
            errorContainer.classList.remove('hidden');
        }

        function clearError() {
            const errorContainer = document.getElementById('error-container');
            errorContainer.classList.add('hidden');
        }
        
        // --- AUTHENTICATION ---

        async function handleSpotifyRedirect() {
            const params = new URLSearchParams(window.location.search);
            const code = params.get('code');

            if (code) {
                // User has returned from Spotify with an authorization code
                const codeVerifier = sessionStorage.getItem('spotify_code_verifier');
                if (!codeVerifier) {
                    displayError("Could not find code verifier. Please try logging in again.");
                    return;
                }
                
                try {
                    const token = await getSpotifyToken(code, codeVerifier);
                    spotifyAccessToken = token;
                    document.getElementById('spotify-status').textContent = 'Connected!';
                    document.getElementById('spotify-status').classList.add('text-green-400');
                    document.getElementById('spotify-login-btn').disabled = true;
                    document.getElementById('youtube-login-btn').disabled = false;
                    // Clean the URL
                    window.history.replaceState({}, document.title, window.location.pathname);
                } catch (error) {
                    displayError(`Error getting Spotify token: ${error.message}`);
                }
            }
        }

        async function getSpotifyToken(code, codeVerifier) {
            const response = await fetch('https://accounts.spotify.com/api/token', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    client_id: SPOTIFY_CLIENT_ID,
                    grant_type: 'authorization_code',
                    code: code,
                    redirect_uri: REDIRECT_URI,
                    code_verifier: codeVerifier,
                }),
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error_description || 'Failed to fetch token');
            }

            const data = await response.json();
            return data.access_token;
        }

        // --- GOOGLE AUTH ---
        function onGapiLoad() {
            gapi.load('client', initializeGis);
        }

        function initializeGis() {
            googleTokenClient = google.accounts.oauth2.initTokenClient({
                client_id: YOUTUBE_CLIENT_ID,
                scope: 'https://www.googleapis.com/auth/youtube.force-ssl',
                callback: (tokenResponse) => {
                    if (tokenResponse && tokenResponse.access_token) {
                        gapi.client.setApiKey(YOUTUBE_API_KEY);
                        gapi.client.load('youtube', 'v3', () => {
                             document.getElementById('youtube-status').textContent = 'Connected!';
                             document.getElementById('youtube-status').classList.add('text-green-400');
                             document.getElementById('youtube-login-btn').disabled = true;
                             if (spotifyAccessToken) {
                                 showPlaylistSelection();
                             }
                        });
                    }
                },
            });
        }

        // --- UI LOGIC & API CALLS ---
        async function showPlaylistSelection() {
            document.getElementById('auth-section').classList.add('hidden');
            document.getElementById('playlist-selection-section').classList.remove('hidden');
            document.getElementById('playlist-list').innerHTML = '<p>Loading playlists...</p>';

            try {
                const playlists = await getSpotifyPlaylists();
                renderPlaylists(playlists);
            } catch (error) {
                console.error("Error fetching Spotify playlists:", error);
                document.getElementById('playlist-list').innerHTML = '<p class="text-red-400">Could not load playlists. Your Spotify session might have expired. Please refresh and log in again.</p>';
            }
        }

        function renderPlaylists(playlists) {
            const playlistList = document.getElementById('playlist-list');
            if (!playlists || playlists.length === 0) {
                playlistList.innerHTML = '<p>No playlists found.</p>';
                return;
            }
            playlistList.innerHTML = playlists.map(p => `
                <div class="bg-gray-800 p-4 rounded-lg flex items-center justify-between hover:bg-gray-600 transition duration-200">
                    <div class="flex items-center">
                        <img src="${p.images[0]?.url || 'https://placehold.co/60x60/1DB954/FFFFFF?text=S'}" alt="${p.name}" class="w-16 h-16 rounded-md mr-4">
                        <div>
                            <p class="font-bold">${p.name}</p>
                            <p class="text-sm text-gray-400">${p.tracks.total} tracks</p>
                        </div>
                    </div>
                    <button class="transfer-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg" data-playlist-id="${p.id}" data-playlist-name="${p.name}" data-playlist-description="${p.description || ''}">
                        Transfer
                    </button>
                </div>
            `).join('');
            
            document.querySelectorAll('.transfer-btn').forEach(button => {
                button.addEventListener('click', handleTransfer);
            });
        }

        async function getSpotifyPlaylists(url = 'https://api.spotify.com/v1/me/playlists?limit=50') {
            const response = await fetch(url, {
                headers: { 'Authorization': `Bearer ${spotifyAccessToken}` }
            });
            if (!response.ok) throw new Error('Failed to fetch playlists');
            const data = await response.json();
            let playlists = data.items;
            if (data.next) {
                playlists = playlists.concat(await getSpotifyPlaylists(data.next));
            }
            return playlists;
        }
        
        async function getSpotifyPlaylistTracks(playlistId, url = `https://api.spotify.com/v1/playlists/${playlistId}/tracks?limit=100`) {
             const response = await fetch(url, {
                headers: { 'Authorization': `Bearer ${spotifyAccessToken}` }
            });
            if (!response.ok) throw new Error('Failed to fetch tracks');
            const data = await response.json();
            let tracks = data.items.filter(item => item.track).map(item => ({
                name: item.track.name,
                artist: item.track.artists.map(a => a.name).join(', ')
            }));
            if (data.next) {
                tracks = tracks.concat(await getSpotifyPlaylistTracks(playlistId, data.next));
            }
            return tracks;
        }

        async function createYouTubePlaylist(name, description) {
            const response = await gapi.client.youtube.playlists.insert({
                part: 'snippet,status',
                resource: {
                    snippet: {
                        title: name,
                        description: `Playlist transferred from Spotify. Original description: ${description}`
                    },
                    status: {
                        privacyStatus: 'private'
                    }
                }
            });
            return response.result;
        }

        async function searchYouTube(query) {
             const response = await gapi.client.youtube.search.list({
                part: 'snippet',
                q: query,
                type: 'video',
                maxResults: 1
            });
            return response.result.items[0];
        }

        async function addVideoToYouTubePlaylist(playlistId, videoId) {
            const response = await gapi.client.youtube.playlistItems.insert({
                part: 'snippet',
                resource: {
                    snippet: {
                        playlistId: playlistId,
                        resourceId: {
                            kind: 'youtube#video',
                            videoId: videoId
                        }
                    }
                }
            });
            return response.result;
        }

        async function handleTransfer(event) {
            const button = event.currentTarget;
            const playlistId = button.dataset.playlistId;
            const playlistName = button.dataset.playlistName;
            const playlistDescription = button.dataset.playlistDescription;

            document.getElementById('playlist-selection-section').classList.add('hidden');
            document.getElementById('transfer-progress-section').classList.remove('hidden');
            document.getElementById('transfer-playlist-name').textContent = `Playlist: ${playlistName}`;
            document.getElementById('transfer-log').innerHTML = '';
            document.getElementById('progress-bar').style.width = '0%';
            document.getElementById('progress-text').textContent = 'Initializing...';
            
            let successfulTransfers = 0;
            let failedTransfers = 0;

            try {
                addLog('Fetching tracks from Spotify...');
                const tracks = await getSpotifyPlaylistTracks(playlistId);
                const totalTracks = tracks.length;
                addLog(`Found ${totalTracks} tracks.`);

                addLog(`Creating YouTube playlist "${playlistName}"...`);
                const youtubePlaylist = await createYouTubePlaylist(playlistName, playlistDescription);
                addLog(`YouTube playlist created! ID: ${youtubePlaylist.id}`);

                for (let i = 0; i < totalTracks; i++) {
                    const track = tracks[i];
                    const query = `${track.name} ${track.artist}`;
                    
                    document.getElementById('progress-text').textContent = `(${i + 1}/${totalTracks}) Searching for: ${query}`;
                    
                    try {
                        const searchResult = await searchYouTube(query);
                        if (searchResult && searchResult.id.videoId) {
                            await addVideoToYouTubePlaylist(youtubePlaylist.id, searchResult.id.videoId);
                            addLog(`✅ Successfully added: ${track.name}`, 'text-green-400');
                            successfulTransfers++;
                        } else {
                            addLog(`❌ Could not find: ${track.name}`, 'text-red-400');
                            failedTransfers++;
                        }
                    } catch (searchError) {
                        addLog(`❌ Error adding ${track.name}: ${searchError.message || 'Unknown error'}`, 'text-red-400');
                        failedTransfers++;
                    }

                    document.getElementById('progress-bar').style.width = `${((i + 1) / totalTracks) * 100}%`;
                }
                
                showCompleteScreen(youtubePlaylist.id, successfulTransfers, failedTransfers);

            } catch (error) {
                console.error("Transfer failed:", error);
                addLog(`A fatal error occurred: ${error.message}`, 'text-red-500 font-bold');
                document.getElementById('progress-text').textContent = 'Transfer failed!';
            }
        }
        
        function addLog(message, colorClass = 'text-gray-300') {
            const transferLog = document.getElementById('transfer-log');
            const p = document.createElement('p');
            p.textContent = message;
            p.className = colorClass;
            transferLog.appendChild(p);
            transferLog.scrollTop = transferLog.scrollHeight;
        }

        function showCompleteScreen(playlistId, successCount, failCount) {
            document.getElementById('transfer-progress-section').classList.add('hidden');
            document.getElementById('transfer-complete-section').classList.remove('hidden');
            
            document.getElementById('complete-message').textContent = `Successfully transferred ${successCount} tracks. ${failCount} tracks could not be found.`;
            document.getElementById('youtube-playlist-link').href = `https://music.youtube.com/playlist?list=${playlistId}`;
        }
        
        // --- ON PAGE LOAD & EVENT LISTENERS ---
        window.onload = () => {
            handleSpotifyRedirect();

            document.getElementById('spotify-login-btn').addEventListener('click', async (event) => {
                event.preventDefault();
                clearError();
                if (SPOTIFY_CLIENT_ID === 'YOUR_SPOTIFY_CLIENT_ID') {
                    displayError('Spotify Client ID is not set. Please add your key to the script file.');
                    return;
                }

                const generateRandomString = (length) => {
                    const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
                    let text = '';
                    for (let i = 0; i < length; i++) {
                        text += possible.charAt(Math.floor(Math.random() * possible.length));
                    }
                    return text;
                };

                const sha256 = async (plain) => {
                    const encoder = new TextEncoder();
                    const data = encoder.encode(plain);
                    return window.crypto.subtle.digest('SHA-256', data);
                };

                const base64encode = (input) => {
                    return btoa(String.fromCharCode(...new Uint8Array(input)))
                        .replace(/=/g, '')
                        .replace(/\+/g, '-')
                        .replace(/\//g, '_');
                };
                
                const codeVerifier = generateRandomString(64);
                sessionStorage.setItem('spotify_code_verifier', codeVerifier);
                const hashed = await sha256(codeVerifier);
                const codeChallenge = base64encode(hashed);

                const scope = 'playlist-read-private playlist-read-collaborative';
                const authUrl = new URL("https://accounts.spotify.com/authorize");
                authUrl.search = new URLSearchParams({
                    response_type: 'code',
                    client_id: SPOTIFY_CLIENT_ID,
                    scope: scope,
                    code_challenge_method: 'S256',
                    code_challenge: codeChallenge,
                    redirect_uri: REDIRECT_URI,
                }).toString();
                
                window.location.href = authUrl.toString();
            });

            document.getElementById('youtube-login-btn').addEventListener('click', async () => {
                clearError();
                 if (YOUTUBE_CLIENT_ID === 'YOUR_YOUTUBE_CLIENT_ID' || YOUTUBE_API_KEY === 'YOUR_YOUTUBE_API_KEY') {
                    displayError('Please set your YouTube API Key and Client ID in the script.');
                    return;
                }
                if (googleTokenClient) {
                    googleTokenClient.requestAccessToken();
                } else {
                    displayError("Google authentication is not ready. Please wait a moment and try again.");
                }
            });

            document.getElementById('start-over-btn').addEventListener('click', () => {
                document.getElementById('transfer-complete-section').classList.add('hidden');
                showPlaylistSelection();
            });
        };
    </script>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen">
    <div class="container mx-auto p-4 md:p-8 max-w-3xl w-full">
        <div class="bg-gray-800 rounded-2xl shadow-2xl p-6 md-p-10">
            <header class="text-center mb-8">
                <h1 class="text-4xl font-bold text-green-400">Playlist Porter</h1>
                <p class="text-gray-400 mt-2">Transfer your Spotify playlists to YouTube Music seamlessly.</p>
            </header>

            <!-- Error Message Display -->
            <div id="error-container" class="hidden bg-red-900 border border-red-500 text-red-200 px-4 py-3 rounded-lg relative mb-6" role="alert">
                <strong class="font-bold">Error: </strong>
                <span id="error-message" class="block sm:inline"></span>
            </div>

            <main id="main-content">
                <!-- Step 1: Authentication -->
                <div id="auth-section">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div id="spotify-auth" class="bg-gray-700 p-6 rounded-xl flex flex-col items-center justify-center">
                            <h2 class="text-2xl font-semibold mb-4">Step 1: Connect Spotify</h2>
                            <button id="spotify-login-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg transition duration-300 w-full">
                                Login with Spotify
                            </button>
                            <p id="spotify-status" class="mt-4 text-sm text-gray-400">Not connected.</p>
                        </div>
                        <div id="youtube-auth" class="bg-gray-700 p-6 rounded-xl flex flex-col items-center justify-center">
                            <h2 class="text-2xl font-semibold mb-4">Step 2: Connect YouTube</h2>
                            <button id="youtube-login-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-lg transition duration-300 w-full" disabled>
                                Login with YouTube
                            </button>
                             <p id="youtube-status" class="mt-4 text-sm text-gray-400">Not connected.</p>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Select Playlist -->
                <div id="playlist-selection-section" class="hidden mt-8">
                    <h2 class="text-2xl font-semibold mb-4 text-center">Step 3: Choose a Playlist to Transfer</h2>
                    <div id="playlist-list" class="max-h-96 overflow-y-auto bg-gray-700 p-4 rounded-xl space-y-3">
                        <!-- Playlists will be dynamically inserted here -->
                    </div>
                </div>

                <!-- Step 3: Transfer Progress -->
                <div id="transfer-progress-section" class="hidden mt-8 text-center">
                    <h2 class="text-2xl font-semibold mb-2">Transferring...</h2>
                    <p id="transfer-playlist-name" class="text-gray-400 mb-4"></p>
                    <div class="w-full bg-gray-700 rounded-full h-4 mb-4">
                        <div id="progress-bar" class="bg-blue-500 h-4 rounded-full" style="width: 0%"></div>
                    </div>
                    <p id="progress-text" class="text-sm text-gray-300">Initializing...</p>
                    <div id="transfer-log" class="mt-4 text-left bg-gray-800 p-4 rounded-lg max-h-60 overflow-y-auto text-sm">
                        <!-- Log messages will appear here -->
                    </div>
                </div>
                 <!-- Step 4: Transfer Complete -->
                <div id="transfer-complete-section" class="hidden mt-8 text-center">
                    <h2 class="text-2xl font-semibold mb-2 text-green-400">Transfer Complete!</h2>
                    <p id="complete-message" class="text-gray-300 mb-4"></p>
                    <a id="youtube-playlist-link" href="#" target="_blank" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg inline-block">View on YouTube Music</a>
                    <button id="start-over-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg ml-4">Start New Transfer</button>
                </div>
            </main>
        </div>
        <footer class="text-center mt-6 text-gray-500 text-sm">
            <p>Disclaimer: This tool is not affiliated with Spotify or YouTube.</p>
        </footer>
    </div>
</body>
</html>
